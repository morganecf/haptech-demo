<!doctype html>
<html>
  <head>
  
  <script src="paper-js/dist/paper-full.min.js"></script>
  <script src="socket.io.js"></script>
  <script type="text/paperscript" canvas="canvas"> 

  	// The socket 
  	var socket = io();

  	// Constants
  	var height = view.size.height;
  	var width = view.size.width;
  	var arm_size = 300; 

  	// Function to create a basic black line segment 
  	var segment = function (x1, y1, x2, y2) {
  		var seg = new Path();
	  	seg.strokeColor = 'black';
	  	seg.strokeWidth = 4;
	  	seg.opacity = 0.8;
	  	seg.add(new Point(x1, y1), new Point(x2, y2));
  	};

  	// Somewhat arbitrary 
  	var slingshotPath = function (x) {
  		return -50 * Math.sin(x / 100) + (height - arm_size);
  	};

  	// The ground 
  	var ground = segment(0, height, width, height);

  	// Create the two slingshot arms
 	var armL = segment(width * .33, height, width * .33, height - arm_size);
 	var armR = segment(width * .63, height, width * .63, height - arm_size);

  	// Create the slingshot 
  	var slingshot = new Path();
  	slingshot.add(width * .33, height - arm_size);
	var apex = slingshot.add(new Point(width * .45, slingshotPath(width * .45)));
	slingshot.add(width * .63, height - arm_size)
	slingshot.strokeColor = 'brown';
	slingshot.strokeWidth = 10;
	slingshot.smooth();

	// Create the body we're going to throw. A happy bird! 
	var radius = 20;
	var start = new Point(apex.point.x + 20, apex.point.y - 8);
	var bird = new Path.Circle(start, radius);
	bird.fillColor = 'red';

	// Determines if the point is in the circle
	var touchingBird = function (x, y) {
		var r = Math.pow(bird.position.x - x, 2) + Math.pow(bird.position.y - y, 2);
		return r <= Math.pow(radius, 2);
	};

  	// Functionality to drag the slingshot 
  	var pulling = false;
  	var released = false;
  	canvas.onmousedown = function (event) {
  		//event.preventDefault();
  		// Only send mouse down event if the mouse is touching the bird  
  		if (touchingBird(event.x, event.y)) {
  			socket.emit('mousedown', {x: event.x, y: event.y});
  		}
  	};
  	canvas.onmousemove = function (event) {
  		//console.log('mouse move');
  		if (pulling) {
  			apex.point.y = event.y;
  			apex.point.x = event.x;
  			bird.position.y = event.y;
  			bird.position.x = event.x;

  			socket.emit('mousemove', {x: event.x, y: event.y});
  		}
  	};
  	canvas.onmouseover = function (event) {
  		if (pulling) socket.emit('mousemove', {x: event.x, y: event.y});
  	};
  	canvas.onmouseup = function (event) {
  		pulling = false;
  		released = true;

  		socket.emit('mouseup', {x: event.x, y: event.y});
  	};

  	// Tell the frontend we are ready 
  	socket.emit('ready', {width: width, height: height});

  	// Backend has determined we're dragging the bird 
  	socket.on('pulling', function () {
  		pulling = true;
  	});

  	socket.on('draw', function (pos) {
  		//console.log('drawing?');
  		if (released) {
  			//console.log('drawing from simulation - released');
  			// Slingshot goes back to original position
  			apex.point.y = start.y;
  			apex.point.x = start.x;
  			// Bird goes flying according to simulation 
  			bird.position.y = pos.y;
  			bird.position.x = pos.x;

  			view.draw();
  		}
  	});

  </script>

</head>

<body>
	<canvas id="canvas" width="1000" height="550" keepalive="true"></canvas>
</body>

</html>
